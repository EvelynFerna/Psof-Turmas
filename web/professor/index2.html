<!-- ./web/professor.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Principal do Professor</title>
  <style>
    body{font-family:Arial;margin:20px;}
    header{display:flex;justify-content:space-between;align-items:center;}
    .turma{border:1px solid #ddd;padding:10px;margin:8px 0;border-radius:6px;display:flex;justify-content:space-between}
    button{margin-left:6px;}
  </style>
</head>
<body>
  <header>
    <div>
      <strong id="nomeProfessor">Professor</strong>
    </div>
    <div>
      <button id="btnLogout">Sair</button>
      <button id="btnCadastrar">Cadastrar Turma</button>
    </div>
  </header>

  <h3>Turmas</h3>
  <div id="listaTurmas">Carregando...</div>

  <script>
    const API_BASE = 'http://localhost:3001';
    async function carregar() {
      try {
        const me = await (await fetch(API_BASE + '/api/me', { credentials: 'include' })).json();
        if (!me.professor) { window.location.href = 'login.html'; return; }
        document.getElementById('nomeProfessor').textContent = me.professor.nome;
        const r = await (await fetch(API_BASE + '/api/turmas', { credentials: 'include' })).json();
        const cont = document.getElementById('listaTurmas');
        cont.innerHTML = '';
        if (r.turmas.length === 0) cont.innerHTML = '<p>Nenhuma turma</p>';
        r.turmas.forEach(t => {
          const div = document.createElement('div');
          div.className = 'turma';
          div.innerHTML = `<span>${t.id} - ${t.nome}</span>
            <span>
              <button onclick="visualizar(${t.id},'${encodeURIComponent(t.nome)}')">Visualizar</button>
              <button onclick="excluir(${t.id})">Excluir</button>
            </span>`;
          cont.appendChild(div);
        });
      } catch (err) {
        console.error(err);
      }
    }

    async function excluir(id) {
      if (!confirm('Deseja realmente excluir esta turma?')) return;
      try {
        const resp = await fetch(API_BASE + `/api/turmas/${id}`, { method: 'DELETE', credentials: 'include' });
        const data = await resp.json();
        if (!resp.ok) { alert(data.error || 'Erro'); return; }
        alert('Turma excluÃ­da');
        carregar();
      } catch (err) { console.error(err); }
    }

    function visualizar(id, nomeEnc) {
      const nome = decodeURIComponent(nomeEnc);
      // abre tela de atividades, passando id e nome via querystring
      window.location.href = `atividades.html?turma_id=${id}&turma_nome=${encodeURIComponent(nome)}`;
    }

    document.getElementById('btnCadastrar').addEventListener('click', () => {
      window.location.href = 'cadastrar_turma.html';
    });
    document.getElementById('btnLogout').addEventListener('click', async () => {
      await fetch(API_BASE + '/api/logout', { method: 'POST', credentials: 'include' });
      window.location.href = 'login.html';
    });

    carregar();
  </script>
</body>
</html>
